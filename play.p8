pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
function _init()
 __init__()
 mode = move_around
 draw_mode = draw_move_around
 --s=time()
end

function _update60()
 mode()
 ticks += 1 --ticks
end

function _draw()
 draw_mode()
 print((stat(1)-stat(2))
     .." "..stat(2),
     pc.posx-20,
     pc.posy-60,8)
 print(flr(pc.posx/8)..", "..
       flr(pc.posy/8),
       pc.posx+20,pc.posy+40)
end
-->8
--update and draw functions
function move_around()
 if(btnp()&16!=0) mode=act_menu
  --ðŸ…¾ï¸
 if btn()&15 != 0 then
  --â¬‡ï¸â¬†ï¸âž¡ï¸â¬…ï¸
  local th=dpad_angle[btn()&15]
  if(th) move(pc, btn()&32, th)
   --âŽ
 else
  pc.c = 0
 end
end

function draw_move_around()
 cls()
 camera(pc.posx-60,pc.posy-60)
 map()
 spr(pc.c+pc.fr,
     pc.posx,pc.posy,1,1,
     pc.flipx)
end

function act_menu()
 if btnp(âŽ) then
  mode = move_around
 end
 if btnp(ðŸ…¾ï¸) then
  load("bits.p8")
 end
end
-->8
--frequently called functions
--warning: optimized code ahead
function move(self, spd, th)
 --move self by a 4-bit vector
 --spd 1-bit (fast or slow)
 --th 3-bit (45 deg resolution)
 local t = ticks
 if(t%8==0) self.c = self.c%2+1
  --every 8 ticks
 if spd != 0 and t%2==1
 --if spd!=0 skip 0dd ticks
  or th%2==1 and t%3.414 < 1
  then 
  --if diagonal skip
  --.7071 ticks
  return
 end 
 local dx = d[th][1]
 local dy = d[th][2]
 if dx < 0 then
  self.flipx = false
 elseif dx > 0 then
  self.flipx = true
 end
 
 dx, dy = 
  mcollide(self.posx,
           self.posy,
           dx,dy)
 self.posx += dx
 self.posy += dy
end

function mcollide(posx,posy,
                  dx,dy)
 local mx = (posx)/8
 local my = (posy)/8
 if fget(mget(mx-.125, my),0) 
  and dx<0
  --moving toward wall on left
 or fget(mget(mx+1,my),0)
  and dx>0 then dx=0
  --moving toward wall on right
 end
 if fget(mget(mx, my-.25),0) 
  and dy<0
  --moving toward wall above
 or fget(mget(mx,my+1),0)
  and dy>0 then dy=0
  --moving toward wall below
 end
 return dx,dy
end
-->8
--secret __init__
function __init__()
 --generate most globals here
 poke(0x5f5c,-1)
  --btnp() behavior
 local rsin =
  --rounded pico8 sin values
  --each step is 1/8 of circle
  {[0]=0,-1,-1,-1,0,1,1,1}

 local dpad_bf =
  --holds dpad bit fields
  --â¬‡ï¸â¬†ï¸âž¡ï¸â¬…ï¸
  {0b0010,0b0110,0b0100,0b0101,
   0b0001,0b1001,0b1000,0b1010}

 ticks = 0

 d = {}
  --relates an angle to values
  --to add to posx, posy
  --0={1,0},1={1,-1}...7={1,1}
 for i=0,7 do
  d[i] =
   --{cos(i)=x, sin(i)=y }
   {rsin[(i-2)%8],rsin[i]}
 end

 dpad_angle={}
  --relates a 3-bit angle to a
  --specific 4-bit bit field
  --âž¡ï¸=0, â¬†ï¸âž¡ï¸=1...â¬‡ï¸=6,â¬‡ï¸âž¡ï¸=7
 for i=1,8 do
  dpad_angle[dpad_bf[i]] = i-1 
 end
end
-->8
--data structures
pc =
{
 posx=60,
 posy=60,
 flipx=false,
 fr=17, --sprite
 c=0    --fr offset
}
-->8
--test code
__gfx__
00000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770001a1111a10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700011e11100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000001111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7dddddd6008888000088880000888800008888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666665088888800888888008888880088888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d666666508a8a88008a8a88008a8a88008a8a8800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666665088888800888888008888880088888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666665088888800888888008888880088388800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d66666650888888008888a8008a88880088888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d666666500a00a0000a00a0000a00a0000a00a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6555555d00a00a0000a0000000000a0000a00a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000001000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000101000000000000000001000000000101010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000001000000000000000001000000000100000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000001000000000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000001000000000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000001000000000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000010101010100000000000001000000000000010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000101010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000101010101010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010100000101010101010101010101010101000001010101010000000101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000100000001000000000001000000000101010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000010101010000000000000000000000000100000001000000000001000000010000010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000010000000000000000000000000000000100000001000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000010000000000000000000001000000000101000001000000000001000000000000010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000010101000000000000000001000000000001010101000000000001000000000001010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000001010000000000000001000000000000000001000000000001000000000000010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000010000000000000001000000000000000001000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000010000000000000001000000000000000001000000000001000000010100010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000001000000010000000000000001000000000000000001000000000001000000000101010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000010101000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000001000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000200001a0701e0702207026070260700d07009000080002c0002c0002b0002800025000200001e0001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002000038050330502f0502905020050150501205000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00020000000001205018050130500d050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000200003b0503c050370503705000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
